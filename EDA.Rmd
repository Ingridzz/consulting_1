---
title: "Group 2's Consulting Report"
author: "Kuangyou Chen, Yanbing Chen, Rose Determan, and Biyao Zhang"
output:
  pdf_document: default
---
# Introduction
Razan came to us with questions about her study of the impact of exercise on brain activation. She had three main questions.   
\newline
1. Are there differences in brain region activation before and after the exercise intervention?  
2. Is there a correlation between fitness and brain region activation?  
3. Are there differences between the control group and the treatment group? 
\newline
Due to participant drop-out, there were 15 individuals in the study. This small sample size is a limitation, since many statistical tests would lack sufficient power to confidently make conclusions. If, for example, we ran an ANOVA test, we would risk having either a type I or type II error where we reject a hypothesis that is the true 
hypothesis. Below, we have completed an exploratory data analysis (EDA) with several figures that illustrate the data, but we do  not make strong conclusions about relationships between variables. 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE)
pacman::p_load("tidyverse", "readxl", "esquisse","GGally","ggpubr","magrittr", "DescTools")

#esquisser(data = df0, viewer = "browser")
```

```{r Select relevant columns and tidy data}

text_size <- 10

#import data
df0 <- read_excel("master-beta-extract_Razan.xlsx")
names(df0)[9] <- 'change_vo2'

#The last seven columns include differences pre/post. 
df <- df0%>% select('subj':'post-rh-Hippocampus_rs')

#column that start with pre and post can be made into a single column, so then 
#in visualization we can "facet" by brain region
df <- df %>%
#pivot pre-region
 pivot_longer(
   cols = starts_with("pre-"),
   names_to = "pre_region",
   values_to = "pre_active"
 ) %>%
#pivot post-region
 pivot_longer(
   cols = starts_with("post-"),
   names_to = "post_region",
   values_to = "post_active"
 )


#separate pre/post column names into brain regions, so we can keep only rows
#where the brain regions match

#format pre-region column
df <-  
  separate(df,
  "pre_region",
  into = c('extra', 'pre_region'),
  sep = 4,
  remove = TRUE
) 

#format post region column 
df <-   separate(
  df,
  "pre_region",
  into = c('pre_reg', 'reg'),
  sep = "_",
  remove = TRUE
)
df <- separate(
  df,
  "post_region",
  into = c('extra', 'post_reg'),
  sep = 5,
  remove = TRUE,
  convert = FALSE,
  extra = "warn",
  fill = "warn"
)

df <- separate(
  df,
  "post_reg",
  into = c('post_reg', 'reg'),
  sep = "_",
  remove = TRUE,
  convert = FALSE,
  extra = "warn",
  fill = "warn"
)

#delete extra columns
df %<>% select(-c(extra, reg,"change_vo2"))

#keep columns where pre and post match
df <- df[df$pre_reg == df$post_reg,]

#calculate changes 
df$vo2_ch <- df$PostVo2max - df$PreVo2max
df$active_ch <- df$post_active - df$pre_active

#create longer version -- pre and post are in same column with another column as an indicator
df_long <- df %>%
 pivot_longer(
   cols = c(pre_active, post_active),
   names_to = "time",
   values_to = "activation"
 )

df_long %<>%
 pivot_longer(
   cols = c(PreVo2max, PostVo2max),
   names_to = "time_",
   values_to = "vo2max"
 )

df_long$time %<>% recode(
  "pre_active" = 0,
  "post_active"= 1
)

df_long$time_ %<>% recode(
  "PreVo2max" = 0,
  "PostVo2max"= 1
)

#keep columns where pre and post match
df_long <- df_long[df_long$time == df_long$time_,]
```




# Change in VO$_2$ Max 
```{r Figure 1, echo=FALSE, fig.height=3.1, fig.width=5, fig.align='center', fig.cap="We can see the differing spreads in the treatment and control groups. The minimum and maximum change of VO$_2$ max in the control group is each more extreme than the minimum and maximum in the treatment group. In both groups, most participants have a positive change of max VO$_2$."}
p2 <- ggplot(df0) +
  aes(y = PostVo2max - PreVo2max, x = Group, color = Group) +
  geom_jitter(width = 0.1, size = 2) + 
  theme_minimal()+
  labs(title = expression(paste("Change in ", VO[2]," Max: Treatment and Control",sep="")))+
  ylab(expression(paste("Change in ", VO[2]," Max",sep="")))+
  scale_x_discrete(labels= c("Exercise", "Resistance"))+
  theme(legend.position = "none")+
  theme(text = element_text(size = text_size))   
p2
ggsave('Fig1.png', p2)
```

The treatment group performed an aerobic/endurance exercise training program for 12 weeks (n=10). The control group performed a resistance training program for 12 weeks (n=5), since resistance training has been shown to not impact cardiopulmonary fitness.  

 
\newpage
# Change in VO$_2$ Max and Brain Activation
The abscissa of each point in the below figure shows the change of VO$_2$ max, and the y axis shows the change in brain region activation (Figure 2). The data are mainly distributed in the first and fourth quadrants.   Based on the plot the range of VO$_2$ max in the control group is greater than that in the treatment group.   
```{r Figure 2, fig.height=3.1, fig.width=7.5, fig.align='center', fig.cap="In the entorhinal, hippocampus and parahippocampal regions of the left and right brains, a small number of data in the control group and treatment group had a negative change in VO$_2$ max, and the rest are positive."}
p1 <- ggplot(data = df, mapping = aes(x = vo2_ch, y = active_ch, colour = Group)) +
  geom_point(shape = "circle", size = 2L) +
  geom_hline(yintercept=0, colour = "grey")+
  geom_vline(xintercept=0, colour = "grey")+
  facet_wrap(vars(pre_reg))+
  labs(title = expression(paste("Change in ", VO[2]," Max and Brain Region Activation",sep="")))+
  ylab("Activation Change")+
  xlab("Fitness Change")+
  scale_color_discrete(name="Treatment Group",
                         breaks=c("ET", "RT"),
                         labels=c("Exercise", "Resistance"))+
  theme_minimal()+
  theme(text = element_text(size = text_size))   
ggsave('Fig2.png', p1)
p1
```

\newpage


Figure 3 shows the individual's changes in brain region activation before and after treatment and color coded by treatment group. 

```{r Figure 3, fig.height=3.1, fig.width=7.5, fig.align='center', fig.cap = "We can see that, in general, participants had a slight increase in region activation , regardless of treatment group, although we also see that some had a decrease. "}
ggplot(data = df_long, aes(x= time, y = activation, group = subj, color = as.factor(Group)))+ 
  geom_line(size = 1.2, alpha = 0.75)+
  facet_wrap(vars(pre_reg))+
  labs(title = expression("Change in Brain Region Activation"))+
  ylab(expression("Region Activation"))+
  xlab("Time")+
  scale_color_discrete(name="Treatment Group",
                         breaks=c("ET", "RT"),
                         labels=c("Exercise", "Resistance"))+
  scale_x_continuous(breaks = c(0,1))
```

Figure 4, similarly to Figure 4 illustrates individual's changes before and after treatment. Figure 5 shows separate plots for the exercise group and the resistance training group. In most cases there was a slight increase in fitness.  

```{r Figure 4, fig.height=3.1, fig.width=7.5, fig.cap= "This figure aligns with the below table. In this figure each subject is a line, and the color represents their age, since we could expect older individuals to have a different response than younger participants. Time 0 represents pre-treatment and time 1 represents post treatment." }
df_long$Group1 <- factor(df_long$Group, labels = c("Exercise", "Resistance"))
vo2 <- df_long[df_long$time == 0,] %>% filter(!duplicated(subj)) 
vo2 <- rbind(vo2, df_long[df_long$time == 1,] %>% filter(!duplicated(subj))) 
             
ggplot(data = df_long, aes(x= time, y = vo2max, group = subj, color = Age))+ 
  geom_line(size = 1.2)+
  facet_wrap(vars(Group1))+
  scale_color_viridis_c()+
  xlab("Time")+ 
  ylab(expression(paste(VO[2]," Max",sep="")))+
  labs(title = expression("Change in Fitness"))+
  scale_x_continuous(breaks = c(0,1))
```

```{r Table}
summ <- df_long[df_long$time == 0,] %>% filter(!duplicated(subj)) %>% group_by(Group,time) %>%                        
  summarise_at(vars(vo2max),              
               funs(Mean = mean(.), 
                    Standard_Deviation = sd(.), 
                    Lower_CI_of_Mean_95 = MeanCI(., method ="classic", conf.level = 0.95)[2],
                    Upper_CI_of_Mean_95 = MeanCI(., method ="classic", conf.level = 0.95)[3]))


summ <- rbind(summ, df_long[df_long$time == 1,] %>% filter(!duplicated(subj)) %>% group_by(Group,time) %>%                
                summarise_at(vars(vo2max),              
                             funs(Mean = mean(.), 
                                  Standard_Deviation = sd(.), 
                                  Lower_CI_of_Mean_95 = MeanCI(., method ="classic", conf.level = 0.95)[2],
                                  Upper_CI_of_Mean_95  = MeanCI(., method ="classic", conf.level = 0.95)[3])))
knitr::kable(summ,
             caption = "Summary of Exercise and Resistance Groups Before and After Treatment. At an alpha level of 0.05, there is not a statistically significant difference in the means of VO$_2$ max before and after treatment, or between groups.",
             digits = 1, align = "c")

```

\newpage

Below is a summary of two linear regression models that fits estimated VO$_2$ max with a predictor of time. Based on the standard errors and p-values of the time coefficients,at the 95% confidence level, there is not a statistically significant difference between fitness before and after treatments. 

## Resistance Group
```{r}
summary(lm(formula = vo2max~ time, data = vo2, subset = Group1=="Resistance"))
```

## Exercise Group
```{r}
summary(lm(formula = vo2max~ time, data = vo2, subset = Group1=="Exercise"))
```


\newpage
# Change in Brain Region Activation
Figure 5 shows change in brain region activation for each measured region.  If a point falls in the first or third quadrant, their activation remained either positive or negative for both readings, but if a point is in the second or fourth quadrant, the activation changed from either  
1. negative in the first reading to positive in the second reading or  
2. positive in the first reading to negative in the second reading. 
```{r Figure 5, fig.height=3.1, fig.width=7.5, fig.align='center', fig.cap = "The x-axis shows the pre-treatment level of activation and the y-axis shows the post-treatment level for the same participant. Each region shows a slightly different pattern of points, but no single plot stands out as having a distinct pattern."}
p3 <- ggplot(df, aes(x = pre_active, y = post_active, colour = Group)) +
  geom_point(shape = "circle", size = 2L) +
  geom_hline(yintercept=0, colour = "grey")+
  geom_vline(xintercept=0, colour = "grey")+
  facet_wrap(vars(pre_reg)) +
  labs(title = "Pre and Post Treatment Activation")+
  xlab("Pre-Treatment Activation")+
  ylab("Post-Treatment Activation")+
  scale_color_discrete(name="Treatment Group",
                         breaks=c("ET", "RT"),
                         labels=c("Exercise", "Resistance"))+
  theme_minimal() +
  theme(text = element_text(size = text_size)) 
#ggsave('Fig3.png', p3, height = 6, width = 10)
p3
```

  

# Conclusion 
Based on the provided data, the exercise intervention leads to impacts of varying degrees depending on the individual. Based on our EDA, there is not a detectable linear relationship between fitness and brain region activation.The differences between control and treatment groups follow a similar pattern and we were not able to detect a significant difference. In future studies we would recommend a larger sample size. We would be happy to consult on suggested sample sizes for future projects. 




